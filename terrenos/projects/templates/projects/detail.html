{% extends "base.html" %}

{% block content %}

    <h1 class="card-title">Inversión Real - {{ project.name }}</h1>
    <p class="card-text">Terrenos totales: {{ total_lands }}</p>
    <a href="{% url 'lands:create_multiple' project.id %}" class="btn btn-primary">Agregar terrenos</a>
    <br><br>
    <div class="card">
        {% if total_lands > 0 %}
            <div class="card-header text-center">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="detail-investments-tab" data-bs-toggle="tab" data-bs-target="#detail_investments" type="button" role="tab" aria-controls="detail_investments" aria-selected="true">Detalle de Inversiones</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="summary-investments-tab" data-bs-toggle="tab" data-bs-target="#summary_investments" type="button" role="tab" aria-controls="summary_investments" aria-selected="false">Resumen de Costos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="accountant-investments-tab" data-bs-toggle="tab" data-bs-target="#accountant_investments" type="button" role="tab" aria-controls="accountant_investments" aria-selected="false">Costo Impositivo</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="earnings-investment-tab" data-bs-toggle="tab" data-bs-target="#earning_investment" type="button" role="tab" aria-controls="earning_investment" aria-selected="false">Inversiones para Ganancias</button>
                    </li>
                </ul>
            </div>
            <div class="card-body tab-content" id="tab_content">
                <div class="tab-pane fade show active" id="detail_investments" role="tabpanel" aria-labelledby="detail-investments-tab">
                    {% for key, data in expense_type_data.items %}
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">{{ data.expense_type.description }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover datatable-investments" id="table-{{ key }}">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Detalle</th>
                                            <th>Monto</th>
                                            <th>Moneda</th>
                                            <th>Tasa Cambio</th>
                                            <th>Tipo de Pago</th>
                                            <th>Pagó</th>
                                            <th>Se pagó a</th>
                                            <th>Comprobante</th>
                                            <th>Contable</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for investment in data.investments %}
                                        <tr>
                                            <td>{{ investment.date|date:"d/m/Y" }}</td>
                                            <td>{{ investment.expense_type.description }} ({{ investment.expense_type_detail.description }})</td>
                                            <td>${{ investment.amount|floatformat:2 }}</td>
                                            <td>{{ investment.get_currency_display }}</td>
                                            <td>{{ investment.exchange_rate|floatformat:4 }}</td>
                                            <td>{{ investment.get_payment_type_display }}</td>
                                            <td>{{ investment.payer|default:"N/A" }}</td>
                                            <td>{{ investment.payment_receiver|default:"N/A" }}</td>
                                            <td>{{ investment.receipt_number|default:"N/A" }}</td>
                                            <td>
                                                {% if investment.accountant %}
                                                <span class="badge bg-success">Sí</span>
                                                {% else %}
                                                <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'investments:detail' investment.pk %}" class="btn btn-sm btn-info">Ver</a>
                                                <a href="{% url 'investments:edit' investment.pk %}" class="btn btn-sm btn-warning">Editar</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-info">
                                            <td colspan="2"><strong>Totales:</strong></td>
                                            <td colspan="2"><strong>ARS: ${{ data.total_ars|floatformat:2 }}</strong></td>
                                            <td colspan="2"><strong>USD: ${{ data.total_usd|floatformat:2 }}</strong></td>
                                            <td colspan="5"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="tab-pane fade" id="summary_investments" role="tabpanel" aria-labelledby="summary-investments-tab">
                    <table id="investments_summary_table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Concepto de Inversión</th>
                                <th>Total ARS</th>
                                <th>TC Promedio</th>
                                <th>Total USD</th>
                                <th>USD por Lote</th>
                                <th>% del Total</th>
                                <th>Total Contable ARS</th>
                                <th>ARS por Lote</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, data in expense_type_data.items %}
                            <tr>
                                <td>{{ data.expense_type.description }}</td>
                                <td>{{ data.total_ars|floatformat:2 }}</td>
                                <td>{{ data.avg_exchange_rate|floatformat:2 }}</td>
                                <td>{{ data.total_usd|floatformat:2 }}</td>
                                <td>{{ data.usd_per_land|floatformat:2 }}</td>
                                <td>{{ data.percentage_of_total|floatformat:2 }}%</td>
                                <td>{{ data.total_accountable_ars|floatformat:2 }}</td>
                                <td>{{ data.ars_per_land|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td><strong>TOTAL GENERAL</strong></td>
                                <td><strong>${{ total_general_ars|floatformat:2 }}</strong></td>
                                <td><strong>-</strong></td>
                                <td><strong>${{ total_general_usd|floatformat:2 }}</strong></td>
                                <td><strong>${{ total_general_usd_per_land|floatformat:2 }}</strong></td>
                                <td><strong>100.00%</strong></td>
                                <td><strong>${{ total_general_accountable_ars|floatformat:2 }}</strong></td>
                                <td><strong>${{ total_general_ars_per_land|floatformat:2 }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="tab-pane fade" id="accountant_investments" role="tabpanel" aria-labelledby="accountant-investments-tab"></div>
                <div class="tab-pane fade" id="earning_investment" role="tabpanel" aria-labelledby="earning-investment-tab"></div>
            </div>
        {% endif %}
        <div class="card-footer text-muted text-center">
            <a href="{% url 'projects:edit' project.id %}" class="btn btn-warning">Editar Proyecto</a>
            <a href="{% url 'projects:delete' project.id %}" class="btn btn-danger">Eliminar Proyecto</a>
        </div>
    </div>

<script>
    $(document).ready(function() {
        // Inicializar DataTables para todas las tablas de inversiones
        $('.datatable-investments').each(function() {
            $(this).DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
                },
                order: [[0, 'desc']], // Ordenar por fecha descendente
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                footerCallback: function(row, data, start, end, display) {
                    // Mantener el footer visible
                }
            });
        });
    });
</script>
{% endblock %}